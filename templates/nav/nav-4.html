<!-- 地址簿管理页面，样式共用 nav2 样式 -->
{% load static %}

<div class="nav2-section-title">地址簿管理</div>

{% if default_personal_detail %}
    <div class="nav2-toolbar" aria-label="地址簿工具栏">
        <div style="display:flex;align-items:center;gap:16px;">
            <h3 style="margin:0;ont-size:16px;">{{ default_personal_detail.display_name }}</h3>
            <span class="nav2-status {% if default_personal_detail.personal_type == 'public' %}online{% else %}offline{% endif %}">
                {{ default_personal_detail.personal_type }}
            </span>
            <span style="color:#6a737d;">设备数量: {{ default_personal_detail.device_count }}</span>
        </div>
        <div style="margin-left:auto;">
            <button type="button" class="nav2-btn nav2-primary nav4-add-device-btn">添加设备</button>
        </div>
    </div>

    <!-- 左右分栏布局 -->
    <div style="display:flex;gap:16px;margin-top:16px;">
        <!-- 左侧标签区域 -->
        <div style="width:250px;background:#f6f8fa;border:1px solid #e1e4e8;border-radius:6px;padding:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;ont-size:14px;">标签管理</h4>
                <button type="button" class="nav2-btn nav2-sm nav4-add-tag-btn">添加标签</button>
            </div>

            <div class="nav4-tags-list" style="max-height:500px;overflow-y:auto;padding-right:8px;">
                {% if tags %}
                    {% for tag in tags %}
                        <div class="nav4-tag-item" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.tag }}"
                             style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#ffffff;border:1px solid #e1e4e8;border-radius:6px;margin-bottom:8px;transition:all 0.2s ease;">
                            <span class="nav4-tag-name"
                                  style="background:{{ tag.valid_color }};color:{{ tag.text_color }};padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600;">{{ tag.tag }}</span>
                            <div style="display:flex;gap:8px;">
                                <button type="button" class="nav2-link nav4-edit-tag-btn"
                                        style="font-size:12px;color:#0366d6;">编辑
                                </button>
                                <button type="button" class="nav2-link nav4-delete-tag-btn"
                                        style="font-size:12px;color:#cb2431;">删除
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="nav2-empty" style="font-size:12px;text-align:center;padding:20px 0;">暂无标签数据</div>
                {% endif %}
            </div>
        </div>

        <!-- 右侧设备区域 -->
        <div style="flex:1;background:#f6f8fa;border:1px solid #e1e4e8;border-radius:6px;padding:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h4 style="margin:0;ont-size:14px;">设备管理</h4>
                <div style="display:flex;gap:8px;">
                    <input class="nav2-input nav2-sm" type="text" id="nav4-device-search" placeholder="搜索设备ID或别名"
                           style="width:200px;">
                    <button type="button" class="nav2-btn nav2-sm nav4-search-device-btn">搜索</button>
                </div>
            </div>

            {% if devices %}
                <div class="x-scroll-container">
                    <table class="nav2-table" aria-label="设备列表" data-table-id="nav4-devices">
                        <thead>
                        <tr>
                            <th data-col-key="alias" style="width: 150px;">设备别名</th>
                            <th data-col-key="device_name" style="width: 200px;">设备名称</th>
                            <th data-col-key="os" style="width: 150px;">操作系统</th>
                            <th data-col-key="version" style="width: 100px;">版本</th>
                            <th data-col-key="status" style="width: 80px;">状态</th>
                            <th data-col-key="tags" style="width: 200px;">标签</th>
                            <th data-col-key="actions" style="width: 150px;">操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for device in devices %}
                            <tr data-peer-id="{{ device.peer_id }}" style="transition:all 0.2s ease;">
                                <td style="font-weight:500;">{{ device.alias|default:device.peer_id }}</td>
                                <td>{{ device.device_name }}</td>
                                <td>{{ device.os }}</td>
                                <td>{{ device.version }}</td>
                                <td>
                                    <span class="nav2-status {% if device.is_online %}online{% else %}offline{% endif %}">
                                        {% if device.is_online %}在线{% else %}离线{% endif %}
                                    </span>
                                </td>
                                <td>
                                    {% if device.tags %}
                                        {% for tag in device.tags %}
                                            <span class="nav4-device-tag"
                                                  style="background:#0366d6;color:white;padding:3px 8px;border-radius:10px;font-size:11px;margin-right:6px;font-weight:500;">{{ tag }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span style="color:#6a737d;font-size:11px;">无标签</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="nav2-row-actions">
                                        <button type="button"
                                                class="nav2-link nav4-edit-device-btn"
                                                data-peer-id="{{ device.peer_id }}"
                                                data-alias="{{ device.alias }}" style="color:#0366d6;">
                                            编辑
                                        </button>
                                        <button type="button"
                                                class="nav2-link nav4-delete-device-btn"
                                                data-peer-id="{{ device.peer_id }}" style="color:#cb2431;">
                                            删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="nav2-empty">暂无设备数据</div>
            {% endif %}
        </div>
    </div>
{% else %}
    <div class="nav2-empty">暂无默认地址簿数据</div>
{% endif %}

<!-- 添加标签弹框 -->
<div id="nav4-add-tag-root" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="nav4-add-tag-title">
        <div class="modal-header">
            <h3 id="nav4-add-tag-title" class="modal-title">添加标签</h3>
            <button type="button" class="modal-close" data-close="nav4-add-tag" aria-label="关闭">
                <img src="/static/icons/close.svg" width="16" height="16" alt="" aria-hidden="true">
            </button>
        </div>
        <div class="modal-body">
            <form id="nav4-add-tag-form">
                <input type="hidden" name="guid" value="{{ default_personal.guid }}">
                <div class="nav2-form-row">
                    <label for="nav4-add-tag-name" style="min-width:88px;color:#6a737d;">标签名称</label>
                    <input class="nav2-input nav2-input-full" type="text" name="tag" id="nav4-add-tag-name"
                           placeholder="请输入标签名称" required>
                </div>
                <div class="nav2-form-row">
                    <label for="nav4-add-tag-color" style="min-width:88px;color:#6a737d;">标签颜色</label>
                    <input class="nav2-input nav2-input-full" type="color" name="color" id="nav4-add-tag-color"
                           value="#2da44e" required>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button type="button" class="nav2-btn" data-close="nav4-add-tag">取消</button>
                    <button type="submit" class="nav2-btn nav2-primary">添加</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑标签弹框 -->
<div id="nav4-edit-tag-root" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="nav4-edit-tag-title">
        <div class="modal-header">
            <h3 id="nav4-edit-tag-title" class="modal-title">编辑标签</h3>
            <button type="button" class="modal-close" data-close="nav4-edit-tag" aria-label="关闭">
                <img src="/static/icons/close.svg" width="16" height="16" alt="" aria-hidden="true">
            </button>
        </div>
        <div class="modal-body">
            <form id="nav4-edit-tag-form">
                <input type="hidden" name="tag_id" id="nav4-edit-tag-id">
                <input type="hidden" name="guid" value="{{ default_personal.guid }}">
                <div class="nav2-form-row">
                    <label for="nav4-edit-tag-name" style="min-width:88px;color:#6a737d;">标签名称</label>
                    <input class="nav2-input nav2-input-full" type="text" name="tag" id="nav4-edit-tag-name"
                           placeholder="请输入标签名称" required>
                </div>
                <div class="nav2-form-row">
                    <label for="nav4-edit-tag-color" style="min-width:88px;color:#6a737d;">标签颜色</label>
                    <input class="nav2-input nav2-input-full" type="color" name="color" id="nav4-edit-tag-color"
                           required>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button type="button" class="nav2-btn" data-close="nav4-edit-tag">取消</button>
                    <button type="submit" class="nav2-btn nav2-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 添加设备到地址簿弹框 -->
<div id="nav4-add-device-root" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="nav4-add-device-title">
        <div class="modal-header">
            <h3 id="nav4-add-device-title" class="modal-title">添加设备到地址簿</h3>
            <button type="button" class="modal-close" data-close="nav4-add-device" aria-label="关闭">
                <img src="/static/icons/close.svg" width="16" height="16" alt="" aria-hidden="true">
            </button>
        </div>
        <div class="modal-body">
            <form id="nav4-add-device-form">
                <input type="hidden" name="guid" value="{{ default_personal.guid }}">
                <div class="nav2-form-row">
                    <label for="nav4-add-device-peer-id" style="min-width:88px;color:#6a737d;">设备ID</label>
                    <input class="nav2-input nav2-input-full" type="text" name="peer_id" id="nav4-add-device-peer-id"
                           placeholder="请输入设备ID" required>
                </div>
                <div class="nav2-form-row">
                    <label for="nav4-add-device-alias" style="min-width:88px;color:#6a737d;">设备别名</label>
                    <input class="nav2-input nav2-input-full" type="text" name="alias" id="nav4-add-device-alias"
                           placeholder="请输入设备别名(可选)">
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button type="button" class="nav2-btn" data-close="nav4-add-device">取消</button>
                    <button type="submit" class="nav2-btn nav2-primary">添加</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑设备弹框 -->
<div id="nav4-edit-device-root" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="nav4-edit-device-title">
        <div class="modal-header">
            <h3 id="nav4-edit-device-title" class="modal-title">编辑设备</h3>
            <button type="button" class="modal-close" data-close="nav4-edit-device" aria-label="关闭">
                <img src="/static/icons/close.svg" width="16" height="16" alt="" aria-hidden="true">
            </button>
        </div>
        <div class="modal-body">
            <form id="nav4-edit-device-form">
                <input type="hidden" name="guid" value="{{ default_personal.guid }}">
                <input type="hidden" name="peer_id" id="nav4-edit-device-peer-id">
                <div class="nav2-form-row">
                    <label for="nav4-edit-device-alias" style="min-width:88px;color:#6a737d;">设备别名</label>
                    <input class="nav2-input nav2-input-full" type="text" name="alias" id="nav4-edit-device-alias"
                           placeholder="请输入设备别名" required>
                </div>
                <div class="nav2-form-row">
                    <label style="min-width:88px;color:#6a737d;">标签</label>
                    <select class="nav2-select" name="tags" id="nav4-edit-device-tags" multiple style="height:100px;">
                        {% for tag in tags %}
                            <option value="{{ tag.tag }}">{{ tag.tag }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button type="button" class="nav2-btn" data-close="nav4-edit-device">取消</button>
                    <button type="submit" class="nav2-btn nav2-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

